<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Minhas cores ideais – Formato do Corpo</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#0e1220; color:#eaeaff; margin:0; }
.container { max-width:900px; margin:auto; padding:20px; }
.card { background:#151b34; border-radius:14px; padding:20px; }
h1 { margin-top:0; font-size:22px; }
h2 { font-size:16px; color:#6b8cff; margin:20px 0 10px; }
.hidden { display:none !important; }
.user-bar { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:8px; }
.link-perfil { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; font-size:12px; color:#9ca3af; text-decoration:none; border-radius:8px; }
.link-perfil:hover { color:#eaeaff; background:rgba(55,65,81,.2); }
.link-perfil svg { width:18px; height:18px; fill:currentColor; }
.btn-sair { padding:6px 12px; font-size:12px; font-weight:500; color:#6b7280; background:transparent; border:1px solid rgba(107,114,128,.35); border-radius:8px; cursor:pointer; }
.btn-sair:hover { color:#9ca3af; background:rgba(55,65,81,.2); }
.btn-voltar { margin-bottom:16px; padding:8px 16px; font-size:13px; background:transparent; color:#9ca3af; border:1px solid #2d3a70; border-radius:8px; cursor:pointer; text-decoration:none; display:inline-block; }
.btn-voltar:hover { color:#eaeaff; border-color:#6b8cff; }
.instrucoes { background:rgba(13,19,42,.6); border-radius:10px; padding:16px; margin-bottom:24px; border-left:4px solid #6b8cff; }
.instrucoes h3 { margin:0 0 10px; font-size:14px; color:#6b8cff; }
.instrucoes ul { margin:0; padding-left:20px; color:#9ca3af; font-size:14px; line-height:1.6; }
.upload-group { margin-bottom:20px; }
.upload-group label { display:block; font-size:13px; color:#eaeaff; margin-bottom:6px; }
.upload-group input[type=file] { font-size:13px; color:#9ca3af; }
.upload-group .opcional { font-size:11px; color:#9ca3af; font-style:italic; }
.btn-analisar { margin-top:20px; padding:14px 28px; font-size:16px; font-weight:bold; background:#6b8cff; color:#fff; border:none; border-radius:10px; cursor:pointer; }
.btn-analisar:hover { background:#5a7bef; }
.btn-analisar:disabled { opacity:0.6; cursor:not-allowed; }
.msg-erro { margin-top:16px; padding:12px; background:rgba(239,68,68,.15); border:1px solid #ef4444; border-radius:8px; color:#fca5a5; }
.msg-ok { margin-top:16px; padding:12px; background:rgba(34,197,94,.15); border:1px solid #22c55e; border-radius:8px; color:#4ade80; }
.loading { margin-top:16px; color:#9ca3af; }
.perfil-box { margin-top:24px; padding:16px; background:rgba(13,19,42,.6); border-radius:10px; }
.perfil-box .linha { margin:8px 0; font-size:14px; }
.perfil-box .tag { color:#6b8cff; font-weight:600; }
.paleta { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0 20px; }
.paleta .swatch { width:48px; height:48px; border-radius:8px; border:2px solid rgba(255,255,255,.2); box-shadow:0 2px 8px rgba(0,0,0,.3); }
.paleta .swatch span { display:block; width:100%; height:100%; border-radius:6px; }
.recomendacoes { margin-top:16px; padding:16px; background:#0d132a; border-radius:10px; }
.recomendacoes p { margin:8px 0; line-height:1.5; color:#eaeaff; font-size:14px; }
.aviso-backend { padding:14px; background:rgba(251,191,36,.12); border:1px solid #fbbf24; border-radius:8px; color:#fcd34d; font-size:13px; margin-bottom:20px; line-height:1.5; }
.aviso-backend code { background:rgba(0,0,0,.25); padding:2px 6px; border-radius:4px; font-size:12px; }
iframe[src*="auth/iframe"], iframe[id^="I0_"], iframe[name^="I0_"] { position:fixed!important;left:-9999px!important;top:-9999px!important;width:1px!important;height:1px!important;opacity:0!important;visibility:hidden!important; }
</style>
</head>
<body>

<div id="app" class="container hidden">
  <div class="card">
    <div class="user-bar">
      <span id="userInfo">Olá</span>
      <div class="user-actions">
        <a href="perfil.html" class="link-perfil" aria-label="Perfil"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg> Perfil</a>
        <button type="button" class="btn-sair" id="btnSair">Sair</button>
      </div>
    </div>
    <a href="index.html" class="btn-voltar">← Voltar</a>
    <h1>Minhas cores ideais</h1>
    <p style="color:#9ca3af; margin-bottom:20px;">Análise de colorimetria pessoal com base em fotos da sua pele e cabelo.</p>

    <div class="instrucoes">
      <h3>Como tirar as fotos</h3>
      <ul>
        <li><strong>Rosto:</strong> sem maquiagem, luz natural difusa, fundo neutro.</li>
        <li><strong>Parte interna do braço:</strong> para subtom de pele.</li>
        <li><strong>Cabelo:</strong> próximo à raiz, sem luz direta.</li>
        <li><strong>Parte externa do braço (opcional):</strong> reação ao sol.</li>
        <li>Nenhuma roupa colorida visível; sem filtros, flash ou luz artificial direta.</li>
        <li>Se possível, segure um objeto neutro (folha branca ou cartão cinza) perto do rosto.</li>
      </ul>
    </div>

    <div id="avisoBackend" class="aviso-backend hidden">
      <strong>Análise de cores temporariamente indisponível aqui.</strong><br>
      Para usar esta função no app online, é preciso colocar no ar o backend de colorimetria (pasta <code>backend/</code>) em um serviço como Google Cloud Run e definir a URL em <code>cores.html</code> (<code>API_CORES_URL</code>).<br>
      Para testar no seu computador: rode o backend com <code>uvicorn</code> (veja CORES_PASSO_A_PASSO.md), defina <code>API_CORES_URL = "http://localhost:8000"</code> e abra o app pelo Live Server.
    </div>

    <form id="formCores">
      <div class="upload-group">
        <label for="fotoRosto">1. Rosto (obrigatório)</label>
        <input type="file" id="fotoRosto" name="rosto" accept="image/*" required>
      </div>
      <div class="upload-group">
        <label for="fotoBraco">2. Parte interna do braço (obrigatório)</label>
        <input type="file" id="fotoBraco" name="braco_interno" accept="image/*" required>
      </div>
      <div class="upload-group">
        <label for="fotoCabelo">3. Cabelo (obrigatório)</label>
        <input type="file" id="fotoCabelo" name="cabelo" accept="image/*" required>
      </div>
      <div class="upload-group">
        <label for="fotoBracoExt">4. Parte externa do braço <span class="opcional">(opcional)</span></label>
        <input type="file" id="fotoBracoExt" name="braco_externo" accept="image/*">
      </div>
      <button type="submit" class="btn-analisar" id="btnAnalisar">Analisar minhas cores</button>
    </form>

    <div id="loading" class="loading hidden">Organizando suas recomendações…</div>
    <div id="msgErro" class="msg-erro hidden"></div>
    <div id="resultado" class="hidden">
      <div class="perfil-box">
        <h2>Seu perfil cromático</h2>
        <div id="perfilConteudo"></div>
      </div>
      <div id="paletasConteudo"></div>
      <div class="recomendacoes">
        <h2>Recomendações</h2>
        <div id="recomendacoesConteudo"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){ var s=location.search; if(/^\?v=\d+$/.test(s)||/[?&]v=\d+($|&)/.test(s)){ var q=s.replace(/\?v=\d+&?|&v=\d+&?|&v=\d+$/g,"").replace(/^\?&?$/,"")||""; history.replaceState(null,"",location.pathname+(q?"?"+q:"")); } })();

var API_CORES_URL = "";

var firebaseConfig; try { firebaseConfig = JSON.parse(atob("eyJhcGlLZXkiOiJBSXphU3lBM3NkaWFCNGQ0dDdwRGl5YWVlMGZvY0RfZW1WQkpaRHciLCJhdXRoRG9tYWluIjoibW9kaS01MzY5ZC5maXJlYmFzZWFwcC5jb20iLCJwcm9qZWN0SWQiOiJtb2RpLTUzNjlkIiwic3RvcmFnZUJ1Y2tldCI6Im1vZGktNTM2OWQuZmlyZWJhc2VzdG9yYWdlLmFwcCIsIm1lc3NhZ2luZ1NlbmRlcklkIjoiNjM5NjUyNzM5NTciLCJhcHBJZCI6IjE6NjM5NjUyNzM5NTc6d2ViOmMwMmIzMmZkOTY1Y2ZmNzA1YjBiOGMifQ==")); } catch(e) { firebaseConfig = { apiKey: "SUA_API_KEY" }; }
if (!firebaseConfig || firebaseConfig.apiKey === "SUA_API_KEY") {
  window.location.href = "index.html";
} else {
  firebase.initializeApp(firebaseConfig);
  var auth = firebase.auth();
  auth.onAuthStateChanged(function(user) {
    if (!user) {
      window.location.href = "index.html";
      return;
    }
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("userInfo").textContent = "Olá, " + (user.displayName || user.email);
    if (!API_CORES_URL) document.getElementById("avisoBackend").classList.remove("hidden");
  });
  document.getElementById("btnSair").onclick = function() {
    auth.signOut();
    window.location.href = "index.html";
  };

  document.getElementById("formCores").onsubmit = async function(e) {
    e.preventDefault();
    if (!API_CORES_URL) {
      document.getElementById("msgErro").textContent = "Backend de colorimetria não configurado. Defina API_CORES_URL em cores.html (ou no ambiente).";
      document.getElementById("msgErro").classList.remove("hidden");
      return;
    }
    var btn = document.getElementById("btnAnalisar");
    var loading = document.getElementById("loading");
    var msgErro = document.getElementById("msgErro");
    var resultado = document.getElementById("resultado");
    btn.disabled = true;
    loading.classList.remove("hidden");
    msgErro.classList.add("hidden");
    resultado.classList.add("hidden");
    var formData = new FormData();
    formData.append("rosto", document.getElementById("fotoRosto").files[0]);
    formData.append("braco_interno", document.getElementById("fotoBraco").files[0]);
    formData.append("cabelo", document.getElementById("fotoCabelo").files[0]);
    if (document.getElementById("fotoBracoExt").files.length > 0)
      formData.append("braco_externo", document.getElementById("fotoBracoExt").files[0]);
    try {
      var controller = new AbortController();
      var timeoutId = setTimeout(function() { controller.abort(); }, 120000);
      var res = await fetch(API_CORES_URL + "/analisar", { method: "POST", body: formData, signal: controller.signal });
      clearTimeout(timeoutId);
      var data = await res.json().catch(function() { return null; });
      if (!res.ok) {
        throw new Error(data && data.detail ? data.detail : "Erro " + res.status);
      }
      var p = data.perfil_cromatico || {};
      document.getElementById("perfilConteudo").innerHTML =
        "<div class=\"linha\"><span class=\"tag\">Estação:</span> " + (p.estacao || "-") + "</div>" +
        "<div class=\"linha\"><span class=\"tag\">Subtom:</span> " + (p.subtom || "-") + "</div>" +
        "<div class=\"linha\"><span class=\"tag\">Valor:</span> " + (p.valor || "-") + "</div>" +
        "<div class=\"linha\"><span class=\"tag\">Croma:</span> " + (p.croma || "-") + "</div>" +
        "<div class=\"linha\"><span class=\"tag\">Contraste:</span> " + (p.contraste || "-") + "</div>";
      var paletas = data.paletas || {};
      var htmlPaletas = "";
      ["principal", "neutra", "destaque"].forEach(function(nome) {
        var lista = paletas[nome] || [];
        if (lista.length === 0) return;
        var titulo = nome.charAt(0).toUpperCase() + nome.slice(1);
        htmlPaletas += "<h2>Paleta " + titulo + "</h2><div class=\"paleta\" id=\"paleta-" + nome + "\">";
        lista.forEach(function(c) {
          htmlPaletas += "<div class=\"swatch\" title=\"" + (c.hex || "") + "\"><span style=\"background:" + (c.hex || "#333") + "\"></span></div>";
        });
        htmlPaletas += "</div>";
      });
      document.getElementById("paletasConteudo").innerHTML = htmlPaletas;
      var textos = data.recomendacoes_texto || [];
      document.getElementById("recomendacoesConteudo").innerHTML = textos.map(function(t) {
        return "<p>" + t.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>") + "</p>";
      }).join("");
      resultado.classList.remove("hidden");
    } catch (err) {
      var txt = err.name === "AbortError" ? "O servidor está demorando (pode estar acordando). Tente novamente em 30 segundos." : (err.message || "Erro ao analisar. Verifique se o backend está no ar e a URL está correta.");
      msgErro.textContent = txt;
      msgErro.classList.remove("hidden");
    }
    btn.disabled = false;
    loading.classList.add("hidden");
  };
}
</script>

</body>
</html>
